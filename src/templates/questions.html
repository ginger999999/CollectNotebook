<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>錯題資料庫</title>
</head>
<body>
    <h2>所有錯題</h2>
    <form method="post" action="/update_selected">
    <table border="1">
        <tr>
            <th>題目圖片</th>
            <th>正確答案</th>
            <th>列印</th>
            <th>已選擇</th>
            <th>刪除</th>
        </tr>
        {% for q in questions %}
                <tr>
                    <td>
                        {% if q[0] %}
                        <img src="{{ url_for('static', filename='uploads/' + q[0]) }}" width="200">
                        {% else %}無圖片{% endif %}
                    </td>
                    <td>
                            <input type="text" name="answer_{{ loop.index0 }}" value="{{ q[1] }}">
                    </td>
                    <td>
                        <input type="checkbox" name="mark_{{ loop.index0 }}" {% if q[2] == '1' %}checked{% endif %}>
                    </td>
                    <td>
                        <input type="checkbox" name="selected_{{ loop.index0 }}" {% if q|length > 3 and q[3] == '1' %}checked{% endif %}>
                    </td>
                    <td>
                        <form method="post" action="/delete_question" style="display:inline">
                            <input type="hidden" name="row_index" value="{{ loop.index0 }}">
                            <button type="submit" onclick="return confirm('確定要刪除這一列嗎？')">刪除</button>
                        </form>
                    </td>
                </tr>
        {% endfor %}
    </table>
    <button type="submit">儲存選擇狀態</button>
    <button type="button" onclick="printMarkedImages()">列印</button>
    <script>
    function printMarkedImages() {
        // 取得所有勾選的標註欄位
        var rows = document.querySelectorAll('table tr');
        var markedImages = [];
        var markedAnswers = [];
        for (var i = 1; i < rows.length; i++) { // 跳過標題列
            var markCheckbox = rows[i].querySelector('input[name^="mark_"]');
            if (markCheckbox && markCheckbox.checked) {
                var img = rows[i].querySelector('img');
                var answerInput = rows[i].querySelector('input[name^="answer_"]');
                if (img) markedImages.push(img.getAttribute('src'));
                if (answerInput) markedAnswers.push(answerInput.value);
            }
        }
        if (markedImages.length === 0) {
            alert('請先勾選要列印的標註圖片');
            return;
        }
        // 傳送到後端產生 PDF
        fetch('/generate_pdf', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ images: markedImages, answers: markedAnswers })
        })
        .then(response => response.blob())
        .then(blob => {
            var url = window.URL.createObjectURL(blob);
            var win = window.open(url, '_blank');
            win.focus();
        });
    }
    </script>
    </form>
    <br>
    <a href="/">回首頁</a>
</body>
</html>
